import time
import base64
import requests
import os
from PIL import Image
from io import BytesIO
from config import Config

OPENAI_AVAILABLE = False
client = None
openai_error_message = ""
openai_last_check = 0

def log_openai_response(action_type, response_content, char_limit=1024):
    """
    ØªØ³Ø¬ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø±Ø¯ÙˆØ¯ OpenAI
    """
    print(f"\n{'='*80}")
    print(f"ğŸš¨ OPENAI RESPONSE LOG - {action_type.upper()}")
    print(f"{'='*80}")
    print(f"ğŸ“Š Ø·ÙˆÙ„ Ø§Ù„Ø±Ø¯: {len(response_content)} Ø­Ø±Ù")
    print(f"ğŸ“ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: {char_limit} Ø­Ø±Ù")
    print(f"ğŸ“ˆ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯: {len(response_content) > char_limit}")
    print(f"ğŸ“‹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¯ Ø§Ù„ÙƒØ§Ù…Ù„:")
    print(f"{'='*40}")
    print(response_content)
    print(f"{'='*40}")
    print(f"ğŸ” Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø±Ø¯: ...{response_content[-50:] if len(response_content) > 50 else response_content}")
    print(f"{'='*80}\n")

def check_recommendations(action_type, analysis_text):
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø­ØªÙˆØ§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    """
    print(f"\nğŸ” ÙØ­Øµ Ø§Ù„ØªÙˆØµÙŠØ§Øª - {action_type.upper()}")

    # Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§
    recommendation_keywords = [
        'ØªÙˆØµÙŠØ©', 'ØªÙˆØµÙŠØ§Øª', 'Ø¯Ø®ÙˆÙ„', 'Ø´Ø±Ø§Ø¡', 'Ø¨ÙŠØ¹', 'Ù‡Ø¯Ù', 'Ø£Ù‡Ø¯Ø§Ù', 'ÙˆÙ‚Ù', 'Ø®Ø³Ø§Ø±Ø©',
        'Ù†Ù‚Ø·Ø©', 'Ù†Ù‚Ø§Ø·', 'Ù…Ø®Ø§Ø·Ø±Ø©', 'Ø¹Ø§Ø¦Ø¯', 'Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯', 'Ø§Ù„Ø¨ÙŠØ¹ Ø¹Ù†Ø¯', 'Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¹Ù†Ø¯'
    ]

    has_recommendation = any(keyword in analysis_text for keyword in recommendation_keywords)

    print(f"ğŸ“Š ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª: {has_recommendation}")
    print(f"ğŸ“ ÙØ­Øµ Ø§Ù„ØªÙˆØµÙŠØ§Øª: {'âœ… Ù†Ø¬Ø­' if has_recommendation else 'âš ï¸ ÙØ´Ù„'}")

    if not has_recommendation:
        print("âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙŠÙØªÙ‚Ø¯ ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„!")

    return has_recommendation

def init_openai():
    """
    ØªÙ‡ÙŠØ¦Ø© Ø¹Ù…ÙŠÙ„ OpenAI ÙˆØ§Ø®ØªØ¨Ø§Ø± ØªÙˆÙØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬.
    """
    global OPENAI_AVAILABLE, client, openai_error_message, openai_last_check

    print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...")

    try:
        from openai import OpenAI
        print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù…Ù† Config
        api_key = Config.OPENAI_API_KEY
        print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ù…ÙØªØ§Ø­ API = {api_key[:20]}..." if api_key else "ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ù…ÙØªØ§Ø­ API = None")
        print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: ÙˆØ¬ÙˆØ¯ Ù…ÙØªØ§Ø­ API: {bool(api_key)}")
        print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ø·ÙˆÙ„ Ù…ÙØªØ§Ø­ API: {len(api_key) if api_key else 0}")

        if not api_key or api_key == "your-api-key-here":
            openai_error_message = "Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ù…ÙØªØ§Ø­ OpenAI API"
            print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âŒ ÙØ´Ù„ ÙØ­Øµ Ù…ÙØªØ§Ø­ API - ØºÙŠØ± Ù…ÙƒÙˆÙ† Ø£Ùˆ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠ")
            OPENAI_AVAILABLE = False
            return False

        print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ OpenAI...")
        client = OpenAI(api_key=api_key)
        print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­")

        try:
            print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ø§Ø®ØªØ¨Ø§Ø± ØªÙˆÙØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...")
            models = client.models.list()
            model_ids = [m.id for m in models.data]
            print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(model_ids)} Ù†Ù…ÙˆØ°Ø¬")
            print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø£ÙˆÙ„Ù‰: {model_ids[:5]}")

            if "gpt-4o" not in model_ids:
                openai_error_message = "Ù†Ù…ÙˆØ°Ø¬ GPT-4o ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ"
                print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âŒ Ù†Ù…ÙˆØ°Ø¬ GPT-4o ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…ØªØ§Ø­Ø©")
                OPENAI_AVAILABLE = False
                return False

            print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ GPT-4o!")
            OPENAI_AVAILABLE = True
            openai_error_message = ""
            openai_last_check = time.time()
            print("ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âœ… ØªÙ…Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­!")
            return True

        except Exception as e:
            error_msg = str(e)
            print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬: {error_msg}")
            if "insufficient_quota" in error_msg:
                openai_error_message = "Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯ API. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ù…ÙˆØ§Ù„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ OpenAI API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ."
            elif "invalid_api_key" in error_msg:
                openai_error_message = "Ù…ÙØªØ§Ø­ API ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© OPENAI_API_KEY."
            elif "rate limit" in error_msg.lower():
                openai_error_message = "ØªÙ… ØªØ¬Ø§ÙˆØ² Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§."
            else:
                openai_error_message = f"ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± OpenAI API: {error_msg}"
            OPENAI_AVAILABLE = False
            return False

    except ImportError as e:
        print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âŒ Ø®Ø·Ø£ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø­Ø²Ù…Ø© OpenAI: {e}")
        openai_error_message = f"Ø­Ø²Ù…Ø© OpenAI ØºÙŠØ± Ù…Ø«Ø¨ØªØ©: {e}"
        OPENAI_AVAILABLE = False
        return False
    except Exception as e:
        print(f"ğŸš¨ ØªÙ‡ÙŠØ¦Ø© OpenAI: âŒ Ø®Ø·Ø£ ØªÙ‡ÙŠØ¦Ø© Ø¹Ø§Ù…: {str(e)}")
        openai_error_message = f"Ø®Ø·Ø£ ØªÙ‡ÙŠØ¦Ø© OpenAI: {str(e)}"
        OPENAI_AVAILABLE = False
        return False

def detect_investing_frame(image_str, image_format):
    """
    ÙƒØ´Ù Ø¥Ø·Ø§Ø± investing.com Ø§Ù„Ù…Ø­Ø³Ù†
    """
    try:
        print("ğŸ”„ ÙƒØ´Ù Ø¥Ø·Ø§Ø± INVESTING: Ø¬Ø§Ø±ÙŠ ÙƒØ´Ù Ø¥Ø·Ø§Ø± investing.com...")

        system_prompt = """
        Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ù…Ø®Ø·Ø·Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ù…Ø­ØªØ±Ù. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ Ø§Ù„ÙƒØ´Ù Ø¹Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø¥Ø·Ø§Ø± investing.com ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ.

        **Ø¹Ù„Ø§Ù…Ø§Øª INVESTING.COM Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:**
        - Ù†Øµ "Investing" ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
        - "powered by TradingView"
        - "NASDAQ", "NYSE", Ø£Ùˆ Ø£Ø³Ù…Ø§Ø¡ Ø¨ÙˆØ±ØµØ§Øª Ø£Ø®Ø±Ù‰
        - Ø£Ø³Ù…Ø§Ø¡ Ø´Ø±ÙƒØ§Øª Ù…Ø«Ù„ "Tesla", "Apple", Ø¥Ù„Ø®
        - Ø­Ø¬Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ Ø¨ØªÙ†Ø³ÙŠÙ‚ "1.387M"
        - ØªØ®Ø·ÙŠØ· Ù…Ø­Ø¯Ø¯ Ø¨Ø£Ø²Ø±Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª

        **ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù€ INVESTING.COM:**
        - Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: "15", "30", "1H", "4H", "1D", "1W", "1M"
        - Ø§ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø­ÙŠØ« ØªÙˆØ¬Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¹Ø§Ø¯Ø©
        - "15" ØªØ¹Ù†ÙŠ Ø¹Ø§Ø¯Ø© M15 (15 Ø¯Ù‚ÙŠÙ‚Ø©)
        - "1H" ØªØ¹Ù†ÙŠ H1 (1 Ø³Ø§Ø¹Ø©)
        - "4H" ØªØ¹Ù†ÙŠ H4 (4 Ø³Ø§Ø¹Ø§Øª)

        **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø§Ø³Ù…Ø©:**
        - Ø¥Ø°Ø§ Ø±Ø£ÙŠØª Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø§Øª investing.comØŒ Ø£Ø¹Ø¯ "investing" ÙƒÙ†ÙˆØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±
        - Ø§ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ£Ø¹Ø¯Ù‡ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (M15, H1, H4, Ø¥Ù„Ø®)
        - Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø§Øª investing.comØŒ Ø£Ø¹Ø¯ "unknown" ÙƒÙ†ÙˆØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±
        - Ø¥Ø°Ø§ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠØŒ Ø£Ø¹Ø¯ "UNKNOWN" Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ
        - **Ù„Ø§ ØªØ¹Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ø¹ØªØ°Ø§Ø±Ø§Øª Ø£Ø¨Ø¯Ù‹Ø§**

        ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹: "Ù†ÙˆØ¹_Ø§Ù„Ø¥Ø·Ø§Ø±,Ø§Ù„Ø¥Ø·Ø§Ø±_Ø§Ù„Ø²Ù…Ù†ÙŠ"
        Ù…Ø«Ø§Ù„: "investing,M15" Ø£Ùˆ "unknown,UNKNOWN"
        """

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "Ø­Ù„Ù„ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø·Ø· Ù‡Ø°Ù‡ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù„Ø§Ù…Ø§Øª investing.com ÙˆØ§ÙƒØªØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ. Ø£Ø¹Ø¯ ÙÙ‚Ø· Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: 'Ù†ÙˆØ¹_Ø§Ù„Ø¥Ø·Ø§Ø±,Ø§Ù„Ø¥Ø·Ø§Ø±_Ø§Ù„Ø²Ù…Ù†ÙŠ'"
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/{image_format};base64,{image_str}",
                                "detail": "low"
                            }
                        }
                    ]
                }
            ],
            max_tokens=50,
            temperature=0.1
        )

        result = response.choices[0].message.content.strip()
        print(f"ğŸ”„ Ù†ØªÙŠØ¬Ø© ÙƒØ´Ù Ø¥Ø·Ø§Ø± investing Ø§Ù„Ø®Ø§Ù…: '{result}'")

        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if ',' in result:
            frame_type, timeframe = result.split(',', 1)
            frame_type = frame_type.strip().lower()
            timeframe = timeframe.strip().upper()
            
            # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ "15" ÙƒÙ€ M15 ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ Ù„Ù€ investing.com
            if timeframe == '15':
                timeframe = 'M15'
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±
            if frame_type not in ['investing', 'unknown']:
                frame_type = 'unknown'
            
            print(f"ğŸ”„ ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„: Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø·Ø§Ø±: '{frame_type}'ØŒ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: '{timeframe}'")
            return frame_type, timeframe
        else:
            print(f"ğŸ”„ âŒ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† ÙƒØ´Ù Ø¥Ø·Ø§Ø± investing: '{result}'")
            return "unknown", "UNKNOWN"

    except Exception as e:
        print(f"Ø®Ø·Ø£: ÙØ´Ù„ ÙƒØ´Ù Ø¥Ø·Ø§Ø± investing: {str(e)}")
        return "unknown", "UNKNOWN"

def detect_currency_from_image(image_str, image_format):
    """
    ÙƒØ´Ù Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ù† ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø·Ø·
    """
    try:
        print("ğŸª™ ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„Ø©: Ø¬Ø§Ø±ÙŠ ÙƒØ´Ù Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...")

        system_prompt = """
        Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ù…Ø®Ø·Ø·Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ù…Ø­ØªØ±Ù. Ù…Ù‡Ù…ØªÙƒ Ù‡ÙŠ ÙƒØ´Ù Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ ØµÙˆØ± Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„.

        **ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ÙØ­Øµ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¨Ø¯Ù‚Ø©:**

        **Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ÙØ­Øµ:**
        - Ø¹Ù†ÙˆØ§Ù†/Ø±Ø£Ø³ Ø§Ù„Ù…Ø®Ø·Ø· (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§)
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰
        - Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        - ÙˆØ³ÙŠÙ„Ø© Ø¥ÙŠØ¶Ø§Ø­ Ø£Ùˆ ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ø®Ø·Ø·
        - Ø£ÙŠ Ù†Øµ ÙŠØ¹Ø±Ø¶ Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª

        **ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:**
        - Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: EUR/USD, GBP/USD, USD/JPY, USD/CHF, AUD/USD, USD/CAD, NZD/USD
        - Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ©: EUR/GBP, EUR/JPY, GBP/JPY, Ø¥Ù„Ø®
        - Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©: BTC/USD, ETH/USD, Ø¥Ù„Ø®
        - Ø§Ù„Ø°Ù‡Ø¨: XAU/USD, GOLD
        - Ù…Ø¹ Ø£Ùˆ Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø©: EURUSD, EUR/USD, GBPUSD, GBP/USD, XAUUSD, XAU/USD
        - Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¹Ù…Ù„Ø§Øª Ø£Ø®Ø±Ù‰

        **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø§Ø³Ù…Ø©:**
        - Ø§ÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ù‡Ø¬ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Øµ Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
        - Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ù‡ Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª (Ø¹Ø§Ø¯Ø© 6-7 Ø£Ø­Ø±Ù Ø¨Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©)
        - Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± Ø¹Ø§Ø¯Ø© Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©
        - Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£ÙŠ Ù…Ø¤Ø´Ø± Ù„Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§ØªØŒ Ø£Ø¹Ø¯ÙÙ‡ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (Ù…Ø«Ù„ EUR/USD)
        - Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ø¶Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ØŒ Ø£Ø¹Ø¯ 'UNKNOWN'

        Ø£Ø¹Ø¯ ÙÙ‚Ø· Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ (Ø¨Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø©) Ø£Ùˆ 'UNKNOWN'.
        """

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ Ø¹Ù† ØªØ³Ù…ÙŠØ© Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ù…Ø®Ø·Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù‡Ø°Ø§. Ø§ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚: Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø®Ø·Ø·ØŒ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±ØŒ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†ØŒ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²ØŒ ÙˆØ£ÙŠ ØªØ³Ù…ÙŠØ§Øª Ù†ØµÙŠØ©. Ø£Ø¹Ø¯ ÙÙ‚Ø· Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ø«Ù„ EUR/USD, GBP/USD Ø£Ùˆ UNKNOWN Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„."
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/{image_format};base64,{image_str}",
                                "detail": "low"
                            }
                        }
                    ]
                }
            ],
            max_tokens=100,
            temperature=0.1
        )

        detected_currency = response.choices[0].message.content.strip().upper()
        print(f"ğŸª™ Ù†ØªÙŠØ¬Ø© ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø®Ø§Ù…: '{detected_currency}'")

        # ØªÙ†Ø¸ÙŠÙ ÙˆØªÙˆØ­ÙŠØ¯ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„Ø©
        cleaned_currency = detected_currency.replace(' ', '')
        
        # Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø·Ø© Ù…Ø§Ø¦Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø© (Ù…Ø«Ù„ EURUSD -> EUR/USD)
        if len(cleaned_currency) == 6 and '/' not in cleaned_currency:
            cleaned_currency = f"{cleaned_currency[:3]}/{cleaned_currency[3:]}"
        
        # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø°Ù‡Ø¨ ØªØ­Ø¯ÙŠØ¯Ù‹Ø§
        if 'XAU' in cleaned_currency or 'GOLD' in cleaned_currency:
            cleaned_currency = 'XAU/USD'
        
        print(f"ğŸª™ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù†Ø¸ÙŠÙØ©: '{cleaned_currency}'")

        # Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©
        common_pairs = [
            'EUR/USD', 'GBP/USD', 'USD/JPY', 'USD/CHF', 'AUD/USD', 'USD/CAD', 'NZD/USD',
            'EUR/GBP', 'EUR/JPY', 'GBP/JPY', 'EUR/CHF', 'AUD/JPY', 'USD/CNH', 'USD/SGD',
            'BTC/USD', 'ETH/USD', 'XAU/USD', 'XAG/USD'
        ]

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
        if cleaned_currency in common_pairs:
            print(f"ğŸª™ âœ… ØªÙ… ÙƒØ´Ù Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª ØµØ§Ù„Ø­: '{cleaned_currency}'")
            return cleaned_currency, None
        elif 'UNKNOWN' in cleaned_currency:
            print(f"ğŸª™ âŒ Ù„Ù… ÙŠØªÙ… ÙƒØ´Ù Ø£ÙŠ Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª")
            return 'UNKNOWN', "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©"
        else:
            print(f"ğŸª™ âš ï¸ ØªÙ… ÙƒØ´Ù Ø²ÙˆØ¬ Ø¹Ù…Ù„Ø§Øª ØºÙŠØ± Ø´Ø§Ø¦Ø¹: '{cleaned_currency}'")
            return cleaned_currency, None

    except Exception as e:
        print(f"Ø®Ø·Ø£: ÙØ´Ù„ ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„Ø©: {str(e)}")
        return 'UNKNOWN', f"Ø®Ø·Ø£ ÙÙŠ Ø§ÙƒØªØ´Ø§Ù Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª: {str(e)}"

def validate_currency_consistency(first_currency, second_currency):
    """
    Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ø§ Ø§Ù„Ù…Ø®Ø·Ø·ÙŠÙ† Ù„Ù†ÙØ³ Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
    """
    try:
        print(f"ğŸª™ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø©: Ø§Ù„Ø£ÙˆÙ„Ù‰: '{first_currency}'ØŒ Ø§Ù„Ø«Ø§Ù†ÙŠØ©: '{second_currency}'")

        if first_currency == 'UNKNOWN' or second_currency == 'UNKNOWN':
            print(f"ğŸª™ âš ï¸ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø© - ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ ÙƒÙ„ÙŠÙ‡Ù…Ø§ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")
            return True, None  # ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙØ´Ù„ ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„Ø©

        # ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø³Ø§ÙØ§ØªØŒ ØªØ­ÙˆÙŠÙ„ Ù„Ø£Ø­Ø±Ù ÙƒØ¨ÙŠØ±Ø©)
        first_normalized = first_currency.replace(' ', '').upper()
        second_normalized = second_currency.replace(' ', '').upper()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Ø§ Ù…ØªÙ…Ø§Ø«Ù„ÙŠÙ†
        if first_normalized == second_normalized:
            print(f"ğŸª™ âœ… Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø©")
            return True, None
        else:
            print(f"ğŸª™ âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø© - Ø¹Ù…Ù„Ø§Øª Ù…Ø®ØªÙ„ÙØ©")
            return False, f"âŒ Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ø®ØªÙ„ÙØ©! Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù€ {first_currency} ÙˆØ§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ù€ {second_currency}.\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ± Ù„Ù†ÙØ³ Ø²ÙˆØ¬ Ø§Ù„Ø¹Ù…Ù„Ø§Øª:\nâ€¢ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰: M15 Ù„Ù€ {first_currency}\nâ€¢ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: H4 Ù„Ù€ {first_currency}"

    except Exception as e:
        print(f"Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù…Ù„Ø©: {str(e)}")
        return True, None  # ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£ Ù„ØªØ¬Ù†Ø¨ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

def detect_timeframe_from_image(image_str, image_format):
    """
    ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù…Ù† ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø·Ø· - Ù†Ø³Ø®Ø© Ù…Ø­Ø³Ù†Ø©
    """
    try:
        print("ğŸ•µï¸ ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©...")

        system_prompt = """
        Ø£Ù†Øª Ù…Ø­Ù„Ù„ Ù…Ø®Ø·Ø·Ø§Øª ØªØ¯Ø§ÙˆÙ„ Ù…Ø­ØªØ±Ù. Ù…Ù‡Ù…ØªÙƒ Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù‡ÙŠ ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ ÙÙŠ ØµÙˆØ± Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„.

        ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ÙØ­Øµ ÙƒÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¨Ø¯Ù‚Ø©:

        **Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©:**
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰ (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§)
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Ø´Ø§Ø¦Ø¹Ø© Ø¬Ø¯Ù‹Ø§)
        - Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±ÙƒØ²/Ø§Ù„Ø±Ø£Ø³ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        - Ø´Ø±ÙŠØ· Ø¹Ù†ÙˆØ§Ù†/Ø±Ø£Ø³ Ø§Ù„Ù…Ø®Ø·Ø·

        **Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙÙ„ÙŠØ©:**
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠØ³Ø±Ù‰
        - Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰
        - Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø³ÙÙ„ÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø®Ø·Ø·
        - ØªØ³Ù…ÙŠØ§Øª Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø³ÙŠÙ†ÙŠ (Ù…Ø­ÙˆØ± Ø§Ù„ÙˆÙ‚Øª)
        - Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ©

        **Ù…Ù†Ø§Ø·Ù‚ Ø£Ø®Ø±Ù‰:**
        - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù‚ÙŠØ§Ø³/Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±
        - Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†
        - Ù…Ø±Ø¨Ø¹/ØªØ±Ø§ÙƒØ¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø·Ø·
        - Ø£ÙŠ ØªØ³Ù…ÙŠØ§Øª Ù†ØµÙŠØ© ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©

        **ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:**
        - Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©: M1, M5, M15, M30, H1, H4, D1, W1, MN
        - Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª: 15M, 15m, 1H, 1h, 4H, 4h, 1D, 1d, 1W, 1w
        - ÙƒÙ„Ù…Ø§Øª ÙƒØ§Ù…Ù„Ø©: 1 Minute, 5 Minutes, 15 Minutes, 30 Minutes, 1 Hour, 4 Hours, Daily, Weekly, Monthly
        - Ù…Ø¹ ØªØ³Ù…ÙŠØ§Øª: TF: M15, Timeframe: H4, Period: D1
        - investing.com Ù…Ø­Ø¯Ø¯Ø©: "15" (ØªØ¹Ù†ÙŠ M15), "1H", "4H", Ø¥Ù„Ø®.

        **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø­Ø§Ø³Ù…Ø©:**
        - Ø§ÙØ­Øµ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ù†Ù‡Ø¬ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ØŒ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†
        - Ø§Ù†ØªØ¨Ù‡ Ø¨Ø´ÙƒÙ„ Ø®Ø§Øµ Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„ØªÙŠ ØºØ§Ù„Ø¨Ù‹Ø§ Ù…Ø§ ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
        - Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Øµ Ø§Ù„ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ø²ÙˆØ§ÙŠØ§ ÙˆØ§Ù„Ø­ÙˆØ§Ù
        - Ø§ÙØ­Øµ ÙƒÙ„Ø§ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ÙŠÙ† Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ ÙˆØ§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª
        - Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ø£ÙŠ Ù…Ø¤Ø´Ø± Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠØŒ Ø£Ø¹Ø¯ÙÙ‡
        - Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶Ø­ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„ØŒ Ø£Ø¹Ø¯ 'UNKNOWN'

        Ø£Ø¹Ø¯ ÙÙ‚Ø· Ø±Ù…Ø² Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ Ø£Ùˆ 'UNKNOWN'.
        """

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": system_prompt
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": "Ù‚Ù… Ø¨Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ Ø¹Ù† ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ ÙÙŠ Ù…Ø®Ø·Ø· Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ù‡Ø°Ø§. Ø§ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚: Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±ØŒ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†ØŒ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²ØŒ Ø£Ø³ÙÙ„ Ø§Ù„ÙŠØ³Ø§Ø±ØŒ Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ†ØŒ Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø±ÙƒØ²ØŒ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø³ÙŠÙ†ÙŠØŒ Ø§Ù„Ù„ÙˆØ§Ø­Ù‚ Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©ØŒ ÙˆØ£ÙŠ ØªØ³Ù…ÙŠØ§Øª Ù†ØµÙŠØ©. Ø£Ø¹Ø¯ ÙÙ‚Ø· Ø±Ù…Ø² Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù…Ø«Ù„ M15, H4, D1 Ø£Ùˆ UNKNOWN Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„."
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/{image_format};base64,{image_str}",
                                "detail": "low"
                            }
                        }
                    ]
                }
            ],
            max_tokens=100,
            temperature=0.1
        )

        detected_timeframe = response.choices[0].message.content.strip().upper()
        print(f"ğŸ•µï¸ Ù†ØªÙŠØ¬Ø© ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø®Ø§Ù…: '{detected_timeframe}'")

        # ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„ØµØ­Ø©
        cleaned_timeframe = detected_timeframe.replace(' ', '').replace('TF:', '').replace('TIMEFRAME:', '').replace('PERIOD:', '').replace('TIMEFRAME', '').replace('PERIOD', '')
        print(f"ğŸ•µï¸ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù†Ø¸ÙŠÙ: '{cleaned_timeframe}'")

        # Ø®Ø±ÙŠØ·Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ - Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù‡Ù…! Ø§ÙØ­Øµ Ø§Ù„Ø³Ù„Ø§Ø³Ù„ Ø§Ù„Ø£Ø·ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹
        timeframe_map = {
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª M15 - Ø§ÙØ­Øµ Ù‡Ø°Ù‡ Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø© Ù„Ù€ M1
            '15MINUTES': 'M15', '15MINUTE': 'M15', '15MIN': 'M15', '15M': 'M15', '15m': 'M15', 'M15M': 'M15',
            # Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù€ investing.com "15"
            '15': 'M15',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª M30
            '30MINUTES': 'M30', '30MINUTE': 'M30', '30MIN': 'M30', '30M': 'M30', '30m': 'M30', 'M30M': 'M30',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª H4
            '4HOURS': 'H4', '4HOUR': 'H4', '4H': 'H4', '4h': 'H4', 'H4H': 'H4', '240M': 'H4',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª H1
            '1HOUR': 'H1', '1H': 'H1', '1h': 'H1', 'H1H': 'H1', '60M': 'H1', '60MIN': 'H1',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª D1
            'DAILY': 'D1', '1DAY': 'D1', '1D': 'D1', '1d': 'D1', 'D1D': 'D1',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª W1
            'WEEKLY': 'W1', '1WEEK': 'W1', '1W': 'W1', '1w': 'W1',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª MN
            'MONTHLY': 'MN', '1MONTH': 'MN', 'MN': 'MN',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª M5
            '5MINUTES': 'M5', '5MINUTE': 'M5', '5MIN': 'M5', '5M': 'M5', '5m': 'M5', 'M5M': 'M5',
            # Ø§Ø®ØªÙ„Ø§ÙØ§Øª M1 - Ø§ÙØ­Øµ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
            '1MINUTE': 'M1', '1MIN': 'M1', '1M': 'M1', '1m': 'M1', 'M1M': 'M1'
        }

        # Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„ØªØ§Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹ - Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
        for timeframe_variant, standard_tf in timeframe_map.items():
            if cleaned_timeframe == timeframe_variant:
                print(f"ğŸ•µï¸ Ù…Ø·Ø§Ø¨Ù‚Ø© ØªØ§Ù…Ø©: '{cleaned_timeframe}' -> '{standard_tf}'")
                return standard_tf, None

        # Ø­Ø§ÙˆÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø¬Ø²Ø¦ÙŠØ© Ø¨Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© (Ø§Ù„Ø£Ø·Ø± Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø§Ù„Ø£Ø·ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹)
        priority_timeframes = ['M15', 'M30', 'H4', 'H1', 'D1', 'W1', 'MN', 'M5', 'M1']

        for tf in priority_timeframes:
            if tf in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¦ÙŠØ©: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ '{tf}' ÙÙŠ '{cleaned_timeframe}'")
                return tf, None

        # Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø¥Ø°Ø§ Ø±Ø£ÙŠÙ†Ø§ "15" ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†ØŒ Ø£Ø¹Ø· Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù€ M15
        if '15' in cleaned_timeframe and any(word in cleaned_timeframe for word in ['M', 'MIN', 'MINUTE']):
            print(f"ğŸ•µï¸ Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ '15' ÙÙŠ '{cleaned_timeframe}'ØŒ Ø¥Ø¹Ø§Ø¯Ø© M15")
            return 'M15', None

        # Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø¥Ø°Ø§ Ø±Ø£ÙŠÙ†Ø§ "1" ÙˆÙ„ÙƒÙ† Ù…Ù† Ø§Ù„Ù…Ø­ØªÙ…Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¡Ù‹Ø§ Ù…Ù† "15"ØŒ ÙƒÙ† Ø­Ø°Ø±Ù‹Ø§
        if '1' in cleaned_timeframe and '15' not in cleaned_timeframe and any(word in cleaned_timeframe for word in ['M', 'MIN', 'MINUTE']):
            # Ø£Ø¹Ø¯ M1 ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù…ØªØ£ÙƒØ¯ÙŠÙ† Ø£Ù†Ù‡ Ù„ÙŠØ³ M15
            if cleaned_timeframe in ['1M', '1MIN', '1MINUTE', 'M1']:
                print(f"ğŸ•µï¸ ÙƒØ´Ù M1 Ø§Ù„ÙˆØ§Ø«Ù‚: '{cleaned_timeframe}'")
                return 'M1', None

        # Ø­Ø§ÙˆÙ„ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù…Ø¹ Ø£ÙˆÙ„ÙˆÙŠØ© M15
        if any(word in cleaned_timeframe for word in ['MINUTE', 'MIN', 'M']):
            if '15' in cleaned_timeframe or 'FIFTEEN' in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù M15 Ù…Ù† '{cleaned_timeframe}'")
                return 'M15', None
            elif '30' in cleaned_timeframe or 'THIRTY' in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù M30 Ù…Ù† '{cleaned_timeframe}'")
                return 'M30', None
            elif '5' in cleaned_timeframe or 'FIVE' in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù M5 Ù…Ù† '{cleaned_timeframe}'")
                return 'M5', None
            elif '1' in cleaned_timeframe and '15' not in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù M1 Ù…Ù† '{cleaned_timeframe}'")
                return 'M1', None

        if any(word in cleaned_timeframe for word in ['HOUR', 'H']):
            if '4' in cleaned_timeframe or 'FOUR' in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù H4 Ù…Ù† '{cleaned_timeframe}'")
                return 'H4', None
            elif '1' in cleaned_timeframe:
                print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù H1 Ù…Ù† '{cleaned_timeframe}'")
                return 'H1', None

        if any(word in cleaned_timeframe for word in ['DAY', 'D']):
            print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù D1 Ù…Ù† '{cleaned_timeframe}'")
            return 'D1', None

        if any(word in cleaned_timeframe for word in ['WEEK', 'W']):
            print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù W1 Ù…Ù† '{cleaned_timeframe}'")
            return 'W1', None

        if any(word in cleaned_timeframe for word in ['MONTH', 'MN']):
            print(f"ğŸ•µï¸ Ù‚Ø§Ø¦Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ØªÙ… ÙƒØ´Ù MN Ù…Ù† '{cleaned_timeframe}'")
            return 'MN', None

        print(f"ğŸ•µï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ ØµØ§Ù„Ø­ ÙÙŠ '{cleaned_timeframe}'ØŒ Ø¥Ø¹Ø§Ø¯Ø© UNKNOWN")
        return 'UNKNOWN', None

    except Exception as e:
        print(f"Ø®Ø·Ø£: ÙØ´Ù„ ÙƒØ´Ù Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…Ø­Ø³Ù†: {str(e)}")
        return 'UNKNOWN', None

def validate_timeframe_for_analysis(image_str, image_format, expected_timeframe):
    """
    ØªØ­Ù‚Ù‚ ØµØ§Ø±Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ Ù…Ø¹ ÙƒØ´Ù Ù…Ø­Ø³Ù†
    """
    try:
        print(f"ğŸ•µï¸ ØªØ­Ù‚Ù‚ ØµØ§Ø±Ù…: Ù†ØªÙˆÙ‚Ø¹ '{expected_timeframe}'")

        detected_timeframe, detection_error = detect_timeframe_from_image(image_str, image_format)

        if detection_error:
            return False, f"âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± {expected_timeframe} ÙˆØ§Ø¶Ø­."

        print(f"ğŸ•µï¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ù„Ù…ÙƒØªØ´Ù '{detected_timeframe}'ØŒ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ '{expected_timeframe}'")

        if detected_timeframe == expected_timeframe:
            print(f"ğŸ•µï¸ âœ… Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚")
            return True, None
        elif detected_timeframe == 'UNKNOWN':
            print(f"ğŸ•µï¸ âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ - Ù„Ù… ÙŠØªÙ… ÙƒØ´Ù Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ")
            return False, f"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©. ÙŠØ±Ø¬Ù‰:\nâ€¢ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ ({expected_timeframe}) Ù…Ø±Ø¦ÙŠ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©\nâ€¢ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ {expected_timeframe}\nâ€¢ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Øµ ØºÙŠØ± Ù…Ù‚Ø·ÙˆØ¹"
        else:
            print(f"ğŸ•µï¸ âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ - Ø¥Ø·Ø§Ø± Ø²Ù…Ù†ÙŠ Ø®Ø§Ø·Ø¦")
            return False, f"âŒ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ùˆ {detected_timeframe} ÙˆÙ„ÙƒÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù‡Ùˆ {expected_timeframe}.\n\nÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„ØµØ­ÙŠØ­:\nâ€¢ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„: M15 (15 Ø¯Ù‚ÙŠÙ‚Ø©)\nâ€¢ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: H4 (4 Ø³Ø§Ø¹Ø§Øª)"

    except Exception as e:
        print(f"Ø®Ø·Ø£: ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: {str(e)}")
        return False, f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: {str(e)}"

def get_technical_analysis(image_str, image_format, timeframe=None, previous_analysis=None, action_type="chart_analysis", currency_pair=None):
    """
    Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù€ OpenAI: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ ÙÙ‚Ø·
    Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ§Ø±Ù… Ø¥Ù„Ù‰ 1024 Ø­Ø±Ù
    """
    global client

    if not OPENAI_AVAILABLE:
        raise RuntimeError(f"OpenAI ØºÙŠØ± Ù…ØªÙˆÙØ±: {openai_error_message}")

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØµØ§Ø±Ù… Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ
    if image_str and action_type in ['first_analysis', 'second_analysis']:
        expected_timeframe = 'M15' if action_type == 'first_analysis' else 'H4'
        is_valid, error_msg = validate_timeframe_for_analysis(image_str, image_format, expected_timeframe)
        if not is_valid:
            return error_msg

    max_tokens = 600  # Ø­Ø¯ Ù…Ø­Ø§ÙØ¸ Ù„Ù€ 1024 Ø­Ø±Ù

    if action_type == "first_analysis":
        analysis_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ†ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ M15.

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ÙƒØ§Ù…Ù„ ÙŠØªØ¶Ù…Ù†:**

### ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ù„Ù€ M15
**ğŸ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù… ÙˆÙ‡ÙŠÙƒÙ„ Ø§Ù„Ø³ÙˆÙ‚:**
**ğŸ“Š Ù…Ø³ØªÙˆÙŠØ§Øª ÙÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
**ğŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø­Ø±Ø¬Ø©:**
**ğŸ’§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SMC ÙˆICT:**
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Liquidity)
- Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Order Blocks) 
- Ù‚Ø§ØªÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Session Killers)
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ (Breaker Blocks)

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
- Ù„Ø§ ØªÙ‚Ø¯Ù… Ø£ÙŠ ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

Ø§Ù„Ø¹Ù…Ù„Ø©: {currency_pair if currency_pair else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
"""
    elif action_type == "second_analysis":
        analysis_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ†ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ H4.

Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚ (M15): {previous_analysis}

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ÙƒØ§Ù…Ù„ ÙŠØªØ¶Ù…Ù†:**

### ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ù„Ù€ H4
**ğŸ¯ Ø§Ù„Ø¯Ù…Ø¬ Ø¨ÙŠÙ† Ø§Ù„Ø¥Ø·Ø§Ø±ÙŠÙ† Ø§Ù„Ø²Ù…Ù†ÙŠÙŠÙ†:**
**ğŸ“Š ØªØ­Ù„ÙŠÙ„ ÙÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
**ğŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ©:**
**ğŸ’§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø£ÙƒØ¨Ø±:**
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Liquidity)
- Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Order Blocks)
- Ù‚Ø§ØªÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Session Killers)

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
- Ù„Ø§ ØªÙ‚Ø¯Ù… Ø£ÙŠ ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

Ø§Ù„Ø¹Ù…Ù„Ø©: {currency_pair if currency_pair else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
"""
    elif action_type == "final_analysis":
        analysis_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†.

Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ (M15): {previous_analysis}
Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ (H4): {user_analysis}

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ù„ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠ Ù…ØªÙƒØ§Ù…Ù„ ÙŠØªØ¶Ù…Ù†:**

### ğŸ“ˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„
**ğŸ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ:**
**ğŸ“Š Ù…Ø³ØªÙˆÙŠØ§Øª ÙÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ Ø§Ù„Ø­Ø±Ø¬Ø©:**
**ğŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
**ğŸ’§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SMC ÙˆICT**

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
- Ù„Ø§ ØªÙ‚Ø¯Ù… Ø£ÙŠ ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

Ø§Ù„Ø¹Ù…Ù„Ø©: {currency_pair if currency_pair else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
"""
    else:  # single_analysis
        analysis_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ†ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ.

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ÙƒØ§Ù…Ù„ ÙŠØªØ¶Ù…Ù†:**

### ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ù„Ù€ {timeframe}
**ğŸ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù… ÙˆÙ‡ÙŠÙƒÙ„ Ø§Ù„Ø³ÙˆÙ‚:**
**ğŸ“Š Ù…Ø³ØªÙˆÙŠØ§Øª ÙÙŠØ¨ÙˆÙ†Ø§ØªØ´ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
**ğŸ›¡ï¸ Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø© Ø§Ù„Ø­Ø±Ø¬Ø©:**
**ğŸ’§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SMC ÙˆICT:**
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Liquidity)
- Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Order Blocks)
- Ù‚Ø§ØªÙ„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª (Session Killers)
- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚ (Breaker Blocks)

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ
- Ù„Ø§ ØªÙ‚Ø¯Ù… Ø£ÙŠ ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

Ø§Ù„Ø¹Ù…Ù„Ø©: {currency_pair if currency_pair else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
"""

    try:
        print(f"ğŸš¨ Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ: Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ {action_type}")

        if image_str:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system", 
                        "content": "Ø£Ù†Øª Ù…Ø­Ù„Ù„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ†ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„. Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù."
                    },
                    {
                        "role": "user", 
                        "content": [
                            {"type": "text", "text": analysis_prompt},
                            {"type": "image_url", "image_url": {"url": f"data:image/{image_format.lower()};base64,{image_str}", "detail": "low"}}
                        ]
                    }
                ],
                max_tokens=max_tokens,
                temperature=0.7,
                timeout=30
            )
        else:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system", 
                        "content": "Ø£Ù†Øª Ù…Ø­Ù„Ù„ ÙÙ†ÙŠ Ù…Ø­ØªØ±Ù. Ù‚Ø¯Ù… ØªØ­Ù„ÙŠÙ„Ø§Ù‹ ÙÙ†ÙŠØ§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„. Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù."
                    },
                    {
                        "role": "user", 
                        "content": analysis_prompt
                    }
                ],
                max_tokens=max_tokens,
                temperature=0.7,
                timeout=20
            )

        analysis = response.choices[0].message.content.strip()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„
        if len(analysis) > 1024:
            print(f"âš ï¸ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ: ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù ({len(analysis)})ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹...")
            analysis = analysis[:1021] + "..."

        print(f"âœ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ: Ø§ÙƒØªÙ…Ù„ØŒ Ø§Ù„Ø·ÙˆÙ„: {len(analysis)} Ø­Ø±Ù")
        log_openai_response(f"{action_type}_technical", analysis)
        
        return analysis

    except Exception as e:
        print(f"ğŸš¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ: âŒ ÙØ´Ù„: {str(e)}")
        raise RuntimeError(f"ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ: {str(e)}")

def get_trading_recommendations(technical_analysis, image_str, image_format, timeframe, currency_pair, action_type="chart_analysis"):
    """
    Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù„Ù€ OpenAI: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
    Ù…Ø­Ø¯ÙˆØ¯Ø© Ø¨Ø´ÙƒÙ„ ØµØ§Ø±Ù… Ø¥Ù„Ù‰ 1024 Ø­Ø±Ù
    """
    global client

    if not OPENAI_AVAILABLE:
        raise RuntimeError(f"OpenAI ØºÙŠØ± Ù…ØªÙˆÙØ±: {openai_error_message}")

    max_tokens = 500  # Ø­Ø¯ Ù…Ø­Ø§ÙØ¸ Ù„Ù„ØªÙˆØµÙŠØ§Øª

    # ğŸŸ¡ ÙˆÙ‚Ù Ø®Ø³Ø§Ø±Ø© Ø®Ø§Øµ Ù„Ù„Ø°Ù‡Ø¨ Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ø£Ø®Ø±Ù‰
    if currency_pair and currency_pair.upper() in ['XAU/USD', 'XAUUSD', 'GOLD']:
        stop_loss_instruction = "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: 5 Ù†Ù‚Ø§Ø· Ù„Ù„Ø°Ù‡Ø¨ ÙÙ‚Ø· (ØªØ¹Ø§Ø¯Ù„ 50 Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Øª)"
        print("ğŸŸ¡ ØªÙ… ÙƒØ´Ù Ø§Ù„Ø°Ù‡Ø¨: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙˆØ§Ø¹Ø¯ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø®Ø§ØµØ© (5 Ù†Ù‚Ø§Ø·)")
    else:
        stop_loss_instruction = "Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©: 50 Ù†Ù‚Ø·Ø© ÙÙ‚Ø·"
        print("ğŸŸ¢ Ø¹Ù…Ù„Ø© Ø¹Ø§Ø¯ÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙˆØ§Ø¹Ø¯ ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ© (50 Ù†Ù‚Ø·Ø©)")

    recommendations_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„ Ù…Ø­ØªØ±Ù. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„ØªØ§Ù„ÙŠØŒ Ù‚Ø¯Ù… ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø©.

Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ:
{technical_analysis}

**Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØªØ¶Ù…Ù†:**

### ğŸ’¼ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ù€15 Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
**ğŸ¯ Ø§Ù„ØªÙˆØµÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
- ØªÙˆØµÙŠØ© ÙˆØ§Ø¶Ø­Ø© (Ø´Ø±Ø§Ø¡/Ø¨ÙŠØ¹/Ø§Ù†ØªØ¸Ø§Ø±)
- Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ

**ğŸ“Š Ù†Ù‚Ø§Ø· Ø§Ù„ØªÙ†ÙÙŠØ°:**
- Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
- {stop_loss_instruction}
- Ø£Ù‡Ø¯Ø§Ù Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ (Ù‡Ø¯Ù Ø£ÙˆÙ„ØŒ Ù‡Ø¯Ù Ø«Ø§Ù†ÙŠ)
- Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø§Ø¦Ø¯ (1:2 ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰)

**â° Ø§Ù„ØªÙˆÙ‚ÙŠØª:**
- Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ Ù„Ù„ØªÙ†ÙÙŠØ°: Ø§Ù„Ù€15 Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
- Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù„Ù„ØµÙÙ‚Ø©

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- Ø±ÙƒØ² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°
- ÙƒÙ† Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹
- Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
- Ù„Ø§ ØªÙƒØ±Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ

Ø§Ù„Ø¹Ù…Ù„Ø©: {currency_pair if currency_pair else 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø²Ù…Ù†ÙŠ: {timeframe}
"""

    try:
        print(f"ğŸš¨ Ù…ÙƒØ§Ù„Ù…Ø© ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„: Ø¨Ø¯Ø¡ ØªÙˆØµÙŠØ§Øª {action_type}")

        if image_str:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system", 
                        "content": "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„. Ù‚Ø¯Ù… ØªÙˆØµÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ° Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©. Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù."
                    },
                    {
                        "role": "user", 
                        "content": [
                            {"type": "text", "text": recommendations_prompt},
                            {"type": "image_url", "image_url": {"url": f"data:image/{image_format.lower()};base64,{image_str}", "detail": "low"}}
                        ]
                    }
                ],
                max_tokens=max_tokens,
                temperature=0.7,
                timeout=30
            )
        else:
            response = client.chat.completions.create(
                model="gpt-4o",
                messages=[
                    {
                        "role": "system", 
                        "content": "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªÙˆØµÙŠØ§Øª ØªØ¯Ø§ÙˆÙ„. Ù‚Ø¯Ù… ØªÙˆØµÙŠØ§Øª Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ° Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©. Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù."
                    },
                    {
                        "role": "user", 
                        "content": recommendations_prompt
                    }
                ],
                max_tokens=max_tokens,
                temperature=0.7,
                timeout=20
            )

        recommendations = response.choices[0].message.content.strip()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„
        if len(recommendations) > 1024:
            print(f"âš ï¸ Ø§Ù„ØªÙˆØµÙŠØ§Øª: ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù ({len(recommendations)})ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹...")
            recommendations = recommendations[:1021] + "..."

        print(f"âœ… ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„: Ø§ÙƒØªÙ…Ù„ØªØŒ Ø§Ù„Ø·ÙˆÙ„: {len(recommendations)} Ø­Ø±Ù")
        log_openai_response(f"{action_type}_recommendations", recommendations)
        
        return recommendations

    except Exception as e:
        print(f"ğŸš¨ ØªÙˆØµÙŠØ§Øª Ø§Ù„ØªØ¯Ø§ÙˆÙ„: âŒ ÙØ´Ù„: {str(e)}")
        # Ø¥Ø±Ø¬Ø§Ø¹ ØªÙˆØµÙŠØ§Øª ÙØ§Ø±ØºØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„ÙØ´Ù„ completamente
        return "ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠØ§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ."

def get_user_feedback(user_analysis_text):
    """
    Ù…ÙƒØ§Ù„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ØªÙ‚ÙŠÙŠÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…)
    """
    global client

    if not OPENAI_AVAILABLE:
        raise RuntimeError(f"OpenAI ØºÙŠØ± Ù…ØªÙˆÙØ±: {openai_error_message}")

    feedback_prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ØµØ§Ø±Ù… ÙˆØµØ§Ø¯Ù‚. Ù‚Ù… Ø¨ØªÙ‚ÙŠÙŠÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ§Ù„ÙŠ Ø¨ØµØ¯Ù‚ ÙˆÙ…ÙˆØ¶ÙˆØ¹ÙŠØ©.

ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:
{user_analysis_text}

**ØªØ¹Ù„ÙŠÙ…Ø§Øª ØµØ§Ø±Ù…Ø©:**
1. Ù‚ÙŠÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ÙÙ†ÙŠØ© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚
2. ÙƒÙ† ØµØ§Ø¯Ù‚Ù‹Ø§ ÙˆÙˆØ§Ø¶Ø­Ù‹Ø§ - Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¶Ø¹ÙŠÙÙ‹Ø§ Ø£Ùˆ Ø®Ø§Ø·Ø¦Ù‹Ø§ØŒ Ù‚Ù„ Ø°Ù„Ùƒ Ø¨ÙˆØ¶ÙˆØ­
3. Ù„Ø§ ØªØ¨Ø§Ù„Øº ÙÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
4. Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¬Ø³ÙŠÙ…Ø© ÙÙŠ Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ
5. Ù‚Ø¯Ù… Ù†Ù‚Ø¯Ù‹Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ù…Ø¹ Ø­Ù„ÙˆÙ„ Ø¹Ù…Ù„ÙŠØ©

**Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©:**
- Ø§Ù„ØªØ²Ù… Ø¨Ù€ 1000 Ø­Ø±Ù ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
- Ù„Ø§ ØªØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù Ø¨Ø£ÙŠ Ø­Ø§Ù„
- ÙƒÙ† Ù…Ø¨Ø§Ø´Ø±Ø§Ù‹ ÙˆÙˆØ§Ø¶Ø­Ø§Ù‹
- Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
- Ù„Ø§ ØªØ¶Ù Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
"""

    try:
        print(f"ğŸš¨ Ù…ÙƒØ§Ù„Ù…Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø¨Ø¯Ø¡ ØªÙ‚ÙŠÙŠÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")

        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system", 
                    "content": "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ØªØ­Ù„ÙŠÙ„ ÙÙ†ÙŠ ØµØ§Ø±Ù…. Ù‚Ø¯Ù… ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ ØµØ§Ø¯Ù‚Ø§Ù‹ ÙˆÙ…ÙˆØ¶ÙˆØ¹ÙŠØ§Ù‹ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…. Ø§Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù."
                },
                {
                    "role": "user", 
                    "content": feedback_prompt
                }
            ],
            max_tokens=600,
            temperature=0.7,
            timeout=20
        )

        feedback = response.choices[0].message.content.strip()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·ÙˆÙ„
        if len(feedback) > 1024:
            print(f"âš ï¸ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ØªØ¬Ø§ÙˆØ² 1024 Ø­Ø±Ù ({len(feedback)})ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù‚ØªØ·Ø§Ø¹...")
            feedback = feedback[:1021] + "..."

        print(f"âœ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ø§ÙƒØªÙ…Ù„ØŒ Ø§Ù„Ø·ÙˆÙ„: {len(feedback)} Ø­Ø±Ù")
        
        return feedback, ""  # Ø¥Ø±Ø¬Ø§Ø¹ ØªÙˆØµÙŠØ§Øª ÙØ§Ø±ØºØ© Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

    except Exception as e:
        print(f"ğŸš¨ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: âŒ ÙØ´Ù„: {str(e)}")
        raise RuntimeError(f"ÙØ´Ù„ ØªÙ‚ÙŠÙŠÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {str(e)}")

def load_image_from_url(image_url):
    """ØªØ­Ù…ÙŠÙ„ ÙˆØªØ´ÙÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† URL ÙˆØ¥Ø±Ø¬Ø§Ø¹ (b64string, format) Ø£Ùˆ (None, None)"""
    try:
        print(f"ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† {image_url}")
        response = requests.get(image_url, timeout=10)
        if response.status_code == 200:
            img = Image.open(BytesIO(response.content))
            if img.format in ['PNG', 'JPEG', 'JPG']:
                buffered = BytesIO()
                img_format = img.format if img.format else 'JPEG'
                img.save(buffered, format=img_format)
                b64_data = base64.b64encode(buffered.getvalue()).decode("utf-8")
                print(f"ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚: {img_format}ØŒ Ø§Ù„Ø­Ø¬Ù…: {len(b64_data)} Ø­Ø±Ù")
                return b64_data, img_format
        print(f"ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ø§Ù„Ø­Ø§Ù„Ø©: {response.status_code}")
        return None, None
    except Exception as e:
        print(f"ğŸš¨ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: {e}")
        return None, None

# Ø¥Ø²Ø§Ù„Ø© ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‚ØµÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
