<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      padding: 20px; 
      background-color: #f8f9fa;
    }
    header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:20px;
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    table { 
      width:100%; 
      border-collapse: collapse; 
      margin-bottom: 24px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th, td { 
      border:1px solid #ddd; 
      padding:12px 8px; 
      text-align:left;
      vertical-align: middle;
    }
    th { 
      background:#f5f5f5; 
      font-weight: 600;
    }
    .success { color: #0a7; font-weight: 500; }
    .danger { color: #c00; font-weight: 500; }
    .small { font-size: 0.9em; color:#666; }
    .controls { 
      margin-bottom: 20px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Fixed: Better key display styling */
    .key-box { 
      background:#e8f4fd; 
      padding:10px 15px; 
      border:2px solid #0066cc; 
      display:inline-block; 
      margin-left:12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 16px;
      color: #0066cc;
      min-width: 120px;
      text-align: center;
    }
    
    /* Fixed: Key column styling to show full key */
    .key-column {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 14px;
      background: #f8f9fa;
      padding: 8px !important;
      min-width: 120px;
      word-break: keep-all;
      white-space: nowrap;
    }
    
    button { 
      padding:8px 16px; 
      cursor:pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-weight: 500;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    input, select { 
      padding:8px; 
      margin-left:6px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .copy-key-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
    }
    .copy-key-btn:hover {
      background: #218838;
    }
    
    .key-generated-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 10px 15px;
      border-radius: 4px;
      margin-top: 10px;
      display: none;
    }
    
    .section-card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h2>Welcome, {{ admin_username or "Admin" }}!</h2>
    </div>
    <div>
      <a href="/admin/logout" style="color: #dc3545; text-decoration: none; font-weight: 500;">Logout</a>
    </div>
  </header>

  <section class="controls">
    <h3>Generate Registration Key</h3>
    <p>Generate a short key for a license. Optionally provide a Telegram ID or @username to pre-bind the key (recommended: use numeric id).</p>
    <div>
      <label>Duration:
        <select id="durationSelect">
          <option value="1">1 month</option>
          <option value="3">3 months</option>
          <option value="6">6 months</option>
          <option value="12">12 months</option>
        </select>
      </label>

      <label style="margin-left:12px">Telegram ID or @username:
        <input id="telegramIdentifier" type="text" placeholder="@username or numeric id" style="width:200px">
      </label>

      <button id="genKeyBtn">Generate Key</button>
      <span id="generatedKey" class="key-box" aria-live="polite" style="display: none;"></span>
      <button id="copyKeyBtn" class="copy-key-btn" style="display: none;" onclick="copyKey()">Copy Key</button>
    </div>
    <div class="small">If you leave the Telegram ID field blank the key will be unbound and the first redeemer will claim it.</div>
    
    <div id="keyGeneratedSuccess" class="key-generated-success">
      <strong>✓ Key Generated Successfully!</strong> Please copy the key above. 
      <button onclick="refreshTable()" style="margin-left: 10px; padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Refresh Table</button>
    </div>
  </section>

  <section class="section-card">
    <h3>Registered Users</h3>
    <table>
      <thead>
        <tr><th>Telegram ID</th><th>Registration Key</th><th>Expiry Date</th><th>Days Left</th><th>Status</th></tr>
      </thead>
      <tbody>
        {% if users and users|length > 0 %}
          {% for u in users %}
            <tr>
              <td>{{ u.telegram_user_id }}</td>
              <td class="key-column">{{ u.registration_key_value or '—' }}</td>
              <td>{{ u.expiry_date or 'N/A' }}</td>
              <td>{{ u.days_left if u.days_left is not none else '—' }}</td>
              <td>
                {% if u.status == 'Active' %}<span class="success">Active</span>
                {% elif u.status == 'Expired' %}<span class="danger">Expired</span>
                {% else %}<span class="small">{{ u.status }}</span>{% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="small">No registered users yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </section>

  <section class="section-card">
    <h3>Generated Keys</h3>
    <table>
      <thead>
        <tr>
          <th>Key</th><th>Duration (months)</th><th>Type</th><th>Allowed Telegram ID</th>
          <th>Created By</th><th>Used</th><th>Used By (telegram)</th><th>Created Date</th><th>Active</th>
        </tr>
      </thead>
      <tbody>
        {% if keys and keys|length > 0 %}
          {% for k in keys %}
            <tr>
              <td class="key-column">{{ k.key_value }}</td>
              <td>{{ k.duration_months }}</td>
              <td>{{ k.key_type_name or 'custom' }}</td>
              <td>{{ k.allowed_telegram_user_id or 'Unbound' }}</td>
              <td>{{ k.created_by_username }}</td>
              <td>{{ 'Yes' if k.used else 'No' }}</td>
              <td>{{ k.used_by_telegram or '—' }}</td>
              <td>{{ k.created_at or 'N/A' }}</td>
              <td>{{ 'Yes' if k.is_active else 'No' }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="9" class="small">No registration keys generated yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </section>

<script>
// Global variable to store the generated key
let currentGeneratedKey = '';

document.getElementById('genKeyBtn').addEventListener('click', async function () {
  const duration = parseInt(document.getElementById('durationSelect').value, 10) || 1;
  const telegram_identifier = document.getElementById('telegramIdentifier').value || null;
  const payload = { duration: duration, telegram_identifier: telegram_identifier };
  
  // Disable button and show loading state
  const btn = this;
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Generating...';
  
  try {
    const res = await fetch('/admin/generate-key', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const data = await res.json();
    if (!res.ok || !data.success) {
      alert('Failed to generate key: ' + (data && data.error ? data.error : res.statusText));
      return;
    }
    
    // Store the key and display it
    currentGeneratedKey = data.key;
    const keyDisplay = document.getElementById('generatedKey');
    const copyBtn = document.getElementById('copyKeyBtn');
    const successMsg = document.getElementById('keyGeneratedSuccess');
    
    keyDisplay.textContent = currentGeneratedKey;
    keyDisplay.style.display = 'inline-block';
    copyBtn.style.display = 'inline-block';
    successMsg.style.display = 'block';
    
    // Auto-select the key text for easy copying
    setTimeout(() => {
      keyDisplay.click();
      selectText(keyDisplay);
    }, 100);
    
    // Clear telegram identifier input
    document.getElementById('telegramIdentifier').value = '';
    
  } catch (err) {
    alert('Error generating key: ' + err.message);
  } finally {
    // Re-enable button
    btn.disabled = false;
    btn.textContent = originalText;
  }
});

// Function to copy the key to clipboard
function copyKey() {
  if (currentGeneratedKey) {
    navigator.clipboard.writeText(currentGeneratedKey).then(function() {
      const copyBtn = document.getElementById('copyKeyBtn');
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'Copied!';
      copyBtn.style.background = '#28a745';
      
      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.style.background = '#28a745';
      }, 2000);
    }).catch(function() {
      // Fallback for older browsers
      const keyDisplay = document.getElementById('generatedKey');
      selectText(keyDisplay);
      alert('Key selected! Press Ctrl+C (or Cmd+C) to copy: ' + currentGeneratedKey);
    });
  }
}

// Function to select text
function selectText(element) {
  if (window.getSelection) {
    const selection = window.getSelection();
    const range = document.createRange();
    range.selectNodeContents(element);
    selection.removeAllRanges();
    selection.addRange(range);
  }
}

// Function to refresh the table
function refreshTable() {
  location.reload();
}

// Click on key to select it
document.getElementById('generatedKey').addEventListener('click', function() {
  selectText(this);
});
</script>
</body>
</html>

