<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    table { width:100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#f5f5f5; }
    .success { color: #0a7; }
    .danger { color: #c00; }
    .small { font-size: 0.9em; color:#666; }
    .controls { margin-bottom: 12px; }
    .key-box { background:#fafafa; padding:8px; border:1px dashed #ccc; display:inline-block; margin-left:12px; }
    button { padding:6px 10px; cursor:pointer; }
    form.inline { display:inline-block; margin-left:10px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h2>Welcome, {{ admin_username or "Admin" }}!</h2>
    </div>
    <div>
      <a href="/admin/logout">Logout</a>
    </div>
  </header>

  <section class="controls">
    <h3>Generate Registration Key</h3>
    <p>Generate a short key for a license. Optionally provide a Telegram ID or @username to bind the key (or choose a key type).</p>
    <div>
      <label>Duration months:
        <input id="durationInput" type="number" min="1" value="1" style="width:80px">
      </label>
      <label style="margin-left:8px">Telegram ID or @username:
        <input id="telegramIdentifier" type="text" placeholder="@username or numeric id" style="width:180px">
      </label>
      <button id="genKeyBtn">Generate Key</button>
      <span id="generatedKey" class="key-box" aria-live="polite"></span>
    </div>
    <div class="small">You can bind the key now or leave it unbound for the first redeemer to claim it.</div>
  </section>

  <section>
    <h3>Registered Users</h3>
    <table>
      <thead>
        <tr>
          <th>Telegram ID</th>
          <th>Registration Key</th>
          <th>Expiry Date</th>
          <th>Days Left</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% if users and users|length > 0 %}
          {% for u in users %}
            <tr>
              <td>{{ u.telegram_user_id }}</td>
              <td>{{ u.registration_key_value or '—' }}</td>
              <td>{{ u.expiry_date or 'N/A' }}</td>
              <td>{{ u.days_left if u.days_left is not none else '—' }}</td>
              <td>
                {% if u.status == 'Active' %}
                  <span class="success">Active</span>
                {% elif u.status == 'Expired' %}
                  <span class="danger">Expired</span>
                {% else %}
                  <span class="small">{{ u.status }}</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="5" class="small">No registered users yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </section>

  <section>
    <h3>Generated Keys</h3>
    <table>
      <thead>
        <tr>
          <th>Key</th>
          <th>Duration (months)</th>
          <th>Type</th>
          <th>Allowed Telegram ID</th>
          <th>Created By</th>
          <th>Used</th>
          <th>Used By (telegram)</th>
          <th>Created Date</th>
          <th>Active</th>
        </tr>
      </thead>
      <tbody>
        {% if keys and keys|length > 0 %}
          {% for k in keys %}
            <tr>
              <td>{{ k.key_value }}</td>
              <td>{{ k.duration_months }}</td>
              <td>{{ k.key_type_name or 'custom' }}</td>
              <td>{{ k.allowed_telegram_user_id or 'Unbound' }}</td>
              <td>{{ k.created_by_username }}</td>
              <td>{{ 'Yes' if k.used else 'No' }}</td>
              <td>{{ k.used_by_telegram or '—' }}</td>
              <td>{{ k.created_at or 'N/A' }}</td>
              <td>{{ 'Yes' if k.is_active else 'No' }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="9" class="small">No registration keys generated yet.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </section>

<script>
document.getElementById('genKeyBtn').addEventListener('click', async function () {
  const duration = parseInt(document.getElementById('durationInput').value) || 1;
  const telegram_identifier = document.getElementById('telegramIdentifier').value || null;
  const payload = { duration: duration, telegram_identifier: telegram_identifier };
  try {
    const res = await fetch('/admin/generate-key', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok || !data.success) {
      alert('Failed to generate key: ' + (data && data.error ? data.error : res.statusText));
      return;
    }
    document.getElementById('generatedKey').textContent = data.key;
    // Refresh page to show new key in table
    setTimeout(()=> location.reload(), 800);
  } catch (err) {
    alert('Error generating key: ' + err.message);
  }
});
</script>
</body>
</html>
